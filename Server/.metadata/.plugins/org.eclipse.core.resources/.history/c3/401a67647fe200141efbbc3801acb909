
package chuhan.gsp.state;

import java.util.Calendar;

import chuhan.gsp.PlatformTypeStr;
import chuhan.gsp.SEnterWorld;
import chuhan.gsp.SQihoo360ExtraInfo;
import chuhan.gsp.attr.PropRole;
import chuhan.gsp.award.CompenseRole;
import chuhan.gsp.exchange.ChargeRole;
import chuhan.gsp.gm.GMInterface;
import chuhan.gsp.hero.BeautyRole;
import chuhan.gsp.hero.HeroColumn;
import chuhan.gsp.hero.PSelectHero;
import chuhan.gsp.hero.TroopColumn;
import chuhan.gsp.item.Bag;
import chuhan.gsp.item.EquipColumn;
import chuhan.gsp.item.SSendTodayRecoverd;
import chuhan.gsp.mail.MailColumn;
import chuhan.gsp.main.ConfigManager;
import chuhan.gsp.msg.MsgRole;
import chuhan.gsp.play.CPlayStatus;
import chuhan.gsp.stage.StageRole;
import chuhan.gsp.task.ActivityRole;
import chuhan.gsp.task.HeroTaskRole;
import chuhan.gsp.util.Conv;
import chuhan.gsp.util.DateUtil;



/**
 * 角色准备登录状态
 * 
 * @author DevUser
 * 
 */
public class PreEntryState extends State {

	public PreEntryState(long roleId) {

		super(roleId);
	}

	@Override
	public boolean enter(int trigger) {

		Integer oldstate = xtable.Roleonoffstate.get(roleId);
		if (oldstate == null)
			oldstate = State.UNENTRY_STATE;
		boolean valid = false;
		if (trigger == State.TRIGGER_ONLINE && oldstate == State.UNENTRY_STATE)
			valid = true;
		if (!valid)
		{
			//yanglk测试登录
//			valid = true;
//			oldstate = State.UNENTRY_STATE;
			enterErrorLog(oldstate, trigger);
			return false;
		}
		xtable.Roleonoffstate.remove(roleId);
		xtable.Roleonoffstate.add(roleId, getState());
		StateManager.logger.info("角色（Id = " + roleId + "）进入状态：" + this.getClass());

		return execute();
	}

	@Override
	public boolean execute() {

		if (!beforeEnterWorld())
			return false;
		sendEnterWorld();
		return trigger(State.TRIGGER_PROCESS_DONE);

	}

	/**
	 * 角色进入游戏前需要进行的处理放在此方法
	 * 三种登入情况，共同的处理放在这里，各自不同的处理覆盖此方法
	 * 
	 * @return
	 */
	protected boolean beforeEnterWorld() {
		try{
			PropRole pRole = PropRole.getPropRole(roleId, false);
//			pRole.sendTips();
		}catch(Exception e)
		{
			e.printStackTrace();
		}
		try{		
			CompenseRole cRole = CompenseRole.getCompenseRole(roleId, false);
			cRole.processWhileOnline();
		}catch(Exception e)	
		{	
			e.printStackTrace();
		}
		
//		new chuhan.gsp.hero.PProcessXiulianAttr(roleId).call();
		new chuhan.gsp.hero.PTuJianInit(roleId).call();//初始化图鉴数据
//		new chuhan.gsp.hero.PResetSkill(roleId).call();
		
		return true;
	}

	/**
	 * 上线时发送协议写在此方法，注意只是发送协议，不要有任何复杂的可能抛出异常的处理
	 * 
	 * 如果有要同步处理的内容，可包装成Procedure，用call调用
	 * 
	 * @return
	 */
	protected void sendEnterWorld() {
		
		/**
		 * 发送SEnterWolrd到客户端
		 */
		gnet.link.Role linkrole = gnet.link.Onlines.getInstance().find(roleId);
		if (linkrole == null)
			return;
		int userId = linkrole.getUserid();
		final xbean.Properties pro = xtable.Properties.get(roleId);
		if (null == pro)
			return;
		if (pro.getUserid() == 0){
			pro.setUserid(userId);
		}
		xbean.AUUserInfo auuser = xtable.Auuserinfo.get(userId);
		if(auuser != null && !pro.getUsername().equals(auuser.getUsername()))
		{
			pro.setUsername(auuser.getUsername());
		}
		if(auuser != null/* && pro.getPlattypestr().isEmpty()*/)
		{
			String[] strs = auuser.getNickname().split("#");
			pro.setPlattypestr(strs[0]);
		}
		PropRole prole = PropRole.getPropRole(roleId, false);
		long now = chuhan.gsp.main.GameTime.currentTimeMillis();
		
		int oldday = DateUtil.getCurrentDay(pro.getOfflinetime());
		int nowday = DateUtil.getCurrentDay(now);
		if(nowday - oldday == 1)
		{
			pro.setContinuelogin(pro.getContinuelogin()+1);
		}
		else if(nowday-oldday > 1)
		{
			pro.setContinuelogin(1);
		}
		pro.setOnlinetime(now);
		
		SEnterWorld senter = new SEnterWorld();
		senter.mydata.roleid = roleId;
		senter.mydata.name = pro.getRolename();
		if(GMInterface.getGMOn())
			senter.mydata.isgm = 1;
		else
			senter.mydata.isgm = (byte)(GMInterface.gmPriv(userId) ? 1 : 0);
		if(ConfigManager.inReviewState())
			senter.mydata.isgm = 2;
		senter.mydata.level = Conv.toShort(pro.getLevel());
		senter.mydata.exp = pro.getExp();
		senter.mydata.viplv = Conv.toByte(pro.getViplv());
		senter.mydata.ti = Conv.toByte(prole.getTili(now));
		senter.mydata.titime = prole.getTiTime(now);
		senter.mydata.battlenum = pro.getBattlenum();
		senter.mydata.hammer = pro.getShenglingzq();
		senter.mydata.freegoldtime = prole.getCJFreeGold(now);
		senter.mydata.freeybtime = prole.getCJFreeYb(now);
		senter.mydata.tibuynum = prole.GetTiBuyNum(now);
		senter.mydata.goldbuynum = prole.GetGoldBuyNum(now);
		senter.mydata.signnum = prole.GetSignNum(now);
		if(prole.isTodaySigned(now))
			senter.mydata.issign = 1;
		else
			senter.mydata.issign = 0;	
		
		MailColumn mailcol = MailColumn.getMailColumn(roleId, true);
		senter.mydata.mailsize = Conv.toByte(mailcol.getxcolumn().getMails().size());
		
		senter.mydata.money = pro.getGold();
		senter.mydata.yuanbao = pro.getYuanbao();
		senter.mydata.servertime = now;
		senter.mydata.timezone = Conv.toByte(Calendar.getInstance().getTimeZone().getRawOffset()/3600000);

		
		HeroColumn herocol = HeroColumn.getHeroColumn(roleId, false);
		senter.mydata.heroes.addAll(herocol.getProtocolHeros());
		
		TroopColumn troopcol = TroopColumn.getTroopColumn(roleId, false);	
		senter.mydata.troops.addAll(troopcol.getProtocolTroops());
		
		senter.mydata.baginfo.putAll(chuhan.gsp.item.Module.getOnlineSendBags(roleId));
		
		xdb.Procedure.psendWhileCommit(roleId, senter);
		CPlayStatus.notifyAll(roleId);
		BeautyRole.getBeautyRole(roleId, true).loginSendSkinInfo();
		
		StringBuilder sb = new StringBuilder("角色登录,roleid:");
		sb.append(roleId).append(",rolename:").append(senter.mydata.name).append(",userid:").append(userId);
		StateManager.logger.info(sb.toString());
		/**********************************************************************************/
		/**
		 * 为了不影响上线
		 * 以下内容都转移到afterEnterWorld或者knight.gsp.PAfterEnterWorld中
		 */
		
		afterEnterWorld(roleId, userId);
	}

	/**
	 * 上线处理结束，进入已登录状态，异步提交的存储过程写在此处 注意其执行的结果不能影响登录流程 注意是异步执行，不能保证其顺序性
	 * 
	 * !!注意，如果在此方法内添加上线处理，一定是Procedure异步提交，不要因为一个模块抛异常而影响登录
	 * 
	 *  如果有要同步处理的内容，可包装成Procedure.call调用
	 */
	protected void afterEnterWorld(final long roleId, int userId) {
		PropRole prole = PropRole.getPropRole(roleId, false);
		
		try{
			StageRole stagerole = StageRole.getStageRole(roleId);
			stagerole.sendAllStages();
		}catch(Exception e)
		{
			e.printStackTrace();
		}
		
		try{
			/*
			if(PlatformTypeStr.isQihoo360(prole.getProperties().getPlattypestr()))
			{
				xbean.AUUserInfo auuser = xtable.Auuserinfo.get(userId);
				if(auuser != null)
				{
					String[] strs = auuser.getNickname().split("#");
					if(strs.length >= 4)
					{
						SQihoo360ExtraInfo qihooext = new SQihoo360ExtraInfo();
						qihooext.uin = strs[1];
						qihooext.token = strs[2];
						qihooext.url = strs[3];
						xdb.Procedure.psendWhileCommit(roleId, qihooext);
					}
				}
			}
			*/
		}catch(Exception e)
		{
			e.printStackTrace();
		}
		
		try{
//			PSelectHero.sendSSendFreeSelectTime(roleId);
		}catch(Exception e)
		{
			e.printStackTrace();
		}
		
		try{
//			SSendTodayRecoverd snd = new SSendTodayRecoverd();
//			snd.huoli = Conv.toByte(prole.getProperties().getRecoverhuo());
//			snd.tili = Conv.toByte(prole.getProperties().getRecoverti());
//			xdb.Procedure.psendWhileCommit(roleId, snd);
//			prole.sendSRefreshVipBuyInfo();
		}catch(Exception e)
		{
			e.printStackTrace();
		}
		
		try{
//			BeautyRole beautyRole = BeautyRole.getBeautyRole(roleId, false);
//			beautyRole.processWhileOnline();
		}catch(Exception e)
		{
			e.printStackTrace();
		}
		try{		
//			ChargeRole cRole = ChargeRole.getChargeRole(roleId, false);
//			cRole.processWhileOnline();
		}catch(Exception e)	
		{	
			e.printStackTrace();
		}	
		try{		
//			MsgRole cRole = MsgRole.getMsgRole(roleId, false);
//			cRole.processWhileOnline();
		}catch(Exception e)	
		{	
			e.printStackTrace();
		}	
		try{		
//			HeroTaskRole cRole = HeroTaskRole.getHeroTaskRole(roleId, false);
//			cRole.sendTasks();
		}catch(Exception e)	
		{	
			e.printStackTrace();
		}	
		try{		
//			ActivityRole cRole = ActivityRole.getActivityRole(roleId, false);
//			cRole.processWhileOnline();
		}catch(Exception e)	
		{	
			e.printStackTrace();
		}	
		
	}
	
	@Override
	public boolean trigger(int trigger) {
	
		if (trigger == State.TRIGGER_PROCESS_DONE)
			return new EntryState(roleId).enter(trigger);
				
		triggerErrorLog(trigger);
		return false;
	}

	@Override
	public int getState() {

		return State.PRE_ENTRY_STATE;
	}

}
